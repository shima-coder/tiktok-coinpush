<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>TikTok Live: COIN FEVER (Portrait)</title>
  <style>
    :root {
      --bg: #05060a;
      --panel:#0e1014;
      --panel2:#10131a;
      --text:#eef1f6;
      --muted:#9aa0a6;
      --acc:#00e5a8;
      --acc2:#5b8cff;
      --hot:#ff4d67;
      --good:#38ef7d;
      --safePad: env(safe-area-inset-top, 8px);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}

    /* ===== Portrait frame =====
       Á´ØÊú´„ÅÆËß£ÂÉèÂ∫¶„Å´‰æùÂ≠ò„Åõ„Åö ‚ÄúÁ∏¶Èï∑(9:16)„ÅÆË¶ã„ÅüÁõÆ‚Äù „ÇíÁ∂≠ÊåÅ„Åó„Å§„Å§„Çπ„Ç±„Éº„É™„É≥„Ç∞„Åó„Åæ„Åô„ÄÇ
    */
    .frame {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: max(8px, var(--safePad));
    }
    .phone {
      /* 9:16 „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÁ∂≠ÊåÅ„Åó„Å§„Å§„ÄÅÁîªÈù¢ÂÜÖ„Å´ÊúÄÂ§ßÂåñ */
      width: min(100vw, 56.25vh);     /* 56.25vh = 9/16 * 100 */
      height: min(177.78vw, 100vh);   /* 177.78vw = 16/9 * 100 */
      max-height: 100%;
      max-width: 100%;
      aspect-ratio: 9/16;
      border: 1px solid #141825;
      border-radius: 20px;
      background: linear-gradient(180deg, #070a10, #05060a);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr auto auto; /* top / stage / leaderboard / log */
      gap: 10px;
      padding: 10px;
    }

    /* ===== TOP BAR ===== */
    .bar{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background: linear-gradient(180deg, #0b0f18, #0a0d14);
      border:1px solid #141825; border-radius:14px;
    }
    .title{ font-weight:700; letter-spacing:.5px; font-size:14px }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0f1420; border:1px solid #192034; color:#cbd5e1; font-size:11px; white-space:nowrap }
    .meter{ position:relative; flex:1; height:12px; background:#0a0e16; border:1px solid #1a2132; border-radius:999px; overflow:hidden }
    .meter > .fill{ position:absolute; inset:0; width:0%; background:linear-gradient(90deg, #0048ff, var(--acc)); transition: width .3s ease }
    .meter-label{ font-size:11px; color:#aab3c2 }

    .topgrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      align-items:center;
    }

    /* ===== STAGE (slot & effects) ===== */
    .stage{
      position:relative; overflow:hidden; border:1px solid #141825; border-radius:16px;
      background: radial-gradient(800px 800px at 50% 10%, #0b1320, #05060a);
      min-height: 54vh; /* Á∏¶„ÅÆÂ§ßÂçä„Çí„Çπ„É≠„ÉÉ„Éà„Å´ */
      display:flex; align-items:center; justify-content:center;
    }
    .slot{
      width: 86%;
      max-width: 560px;
      aspect-ratio: 3/1; /* 3„Çª„É´√ó1ÊÆµ„ÇíÂ§ß„Åç„Åè */
      background: linear-gradient(180deg,#0e1522,#0a0e18);
      border:1px solid #1a2336; border-radius:18px;
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:8px; padding:10px;
      box-shadow: 0 10px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .cell{
      display:flex; align-items:center; justify-content:center;
      font-size: min(12vw, 96px); /* Á´ØÊú´ÂπÖ„Å´Âøú„Åò„Å¶Ëá™ÂãïÊã°Â§ß */
      background: radial-gradient(220px 120px at 50% 45%, #101a2a, #0a0f18);
      border:1px solid #1b2740; border-radius:14px; user-select:none;
    }
    .banner{
      position:absolute; left:50%; top:6%; transform:translateX(-50%);
      padding:8px 14px; border-radius:12px; background:rgba(0,0,0,.35); border:1px solid #1b2333; font-weight:700;
      box-shadow: 0 8px 30px rgba(0,0,0,.4); font-size:14px;
      display:none;
    }
    .combo{
      position:absolute; right:10px; top:10px; background:rgba(0,0,0,.35); border:1px solid #1b2436; border-radius:12px;
      padding:6px 10px; font-weight:700; font-size:13px;
    }
    .combo .x { color:var(--hot) }

    /* effects */
    .float{ position:absolute; pointer-events:none; font-size:22px; filter: drop-shadow(0 6px 10px rgba(0,0,0,.45)); }
    .burst{ position:absolute; pointer-events:none; width:10px; height:10px; border-radius:50%; background:var(--acc); box-shadow:0 0 16px var(--acc2); opacity:.9 }

    /* ===== LEADERBOARD ===== */
    .panel{
      background: linear-gradient(180deg, #0b1018, #080c12);
      border:1px solid #171e2c; border-radius:14px; padding:10px;
    }
    .panel h3{ margin:0 0 6px 0; font-size:14px }
    .lb-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:10px; }
    .lb-item:nth-child(odd){ background: rgba(255,255,255,.02) }
    .rank{ width:22px; text-align:center; color:#a5b4c3; font-size:12px }
    .uid{ flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:12px }
    .score{ font-weight:700; color:#e8eef7; font-size:12px }

    /* ===== LOG ===== */
    .log{ font-size:11px; color:#aab3c2; white-space:pre-line; max-height:18vh; overflow:auto }

    @media (max-width: 420px){
      .title{ font-size:13px }
      .cell{ font-size: min(14vw, 84px) }
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="phone">
      <!-- ===== TOP ===== -->
      <div class="bar">
        <div class="topgrid" style="width:100%">
          <div class="title">üé∞ COIN FEVER Overlay</div>
          <div class="pill">Socket: <span id="conn-status">connecting...</span></div>
          <div class="meter" title="Jackpot Meter" style="grid-column: 1 / -1;">
            <div class="fill" id="jp-fill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <!-- ===== STAGE ===== -->
      <div class="stage" id="stage">
        <div class="slot" id="slot">
          <div class="cell" id="c0">üí∞</div>
          <div class="cell" id="c1">üí∞</div>
          <div class="cell" id="c2">üí∞</div>
        </div>
        <div class="banner" id="banner"></div>
        <div class="combo" id="combo">COMBO <span class="x">x1.0</span></div>
      </div>

      <!-- ===== LEADERBOARD ===== -->
      <div class="panel">
        <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞ Top10Ôºà‰ªäÊó•Ôºâ</h3>
        <div id="lb"></div>
      </div>

      <!-- ===== LOG ===== -->
      <div class="panel">
        <h3>üéØ ÊúÄËøë„ÅÆ„Éí„ÉÉ„Éà</h3>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <!-- Socket.IO CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    // ===== helpers =====
    const $ = (sel) => document.querySelector(sel);
    const EMOJIS = ['üí∞','ü™ô','üíé','‚≠ê','üçÄ','üî•','üéÅ','üéâ'];
    const stage = $('#stage');
    const reelCells = [$('#c0'), $('#c1'), $('#c2')];
    const banner = $('#banner');
    const jpFill = $('#jp-fill');
    const comboEl = $('#combo');
    const connStatus = $('#conn-status');
    const lbEl = $('#lb');
    const logEl = $('#log');

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function now(){ return performance.now(); }

    // ===== jackpot meter =====
    let jpValue = 0; // 0..1
    function addJackpot(deltaScore){
      jpValue = clamp(jpValue + deltaScore/5000, 0, 1);
      jpFill.style.width = (jpValue*100).toFixed(1) + '%';
    }

    // ===== combo =====
    let lastHitAt = 0;
    let comboMul = 1.0;
    function onComboHit(){
      const t = now();
      const dt = (t - lastHitAt) / 1000;
      lastHitAt = t;
      if (dt < 2.5) comboMul = clamp(comboMul + 0.25, 1, 5);
      else comboMul = 1.0;
      comboEl.querySelector('.x').textContent = 'x' + comboMul.toFixed(1);
      comboEl.animate([{transform:'scale(1.0)'},{transform:'scale(1.15)'},{transform:'scale(1.0)'}], {duration:260, easing:'ease-out'});
    }

    // ===== slot animation =====
    async function spinSlot(final='üíé'){
      const t0 = now();
      const dur = 900, sp = 60;
      while (now() - t0 < dur){
        reelCells.forEach(c => c.textContent = EMOJIS[(Math.random()*EMOJIS.length)|0]);
        await sleep(sp);
      }
      reelCells.forEach((c)=> c.textContent = final);
      banner.textContent = final === 'üíé' ? 'MEGA HIT!' : 'HIT!';
      banner.style.display = 'block';
      banner.animate([{opacity:0, transform:'translateY(-6px)'},{opacity:1, transform:'translateY(0)'}], {duration:220, easing:'ease-out'});
      setTimeout(()=> banner.style.display='none', 900);
    }

    // ===== particles / coins =====
    const FLOATS = []; // {el,x,y,t,vy}
    function spawnFloat(x, y, char='ü™ô'){
      const el = document.createElement('div');
      el.className = 'float';
      el.textContent = char;
      stage.appendChild(el);
      FLOATS.push({el, x, y, t:0, vy: - (2 + Math.random()*1.5)});
    }
    function spawnBurst(x, y, n=18){
      for(let i=0;i<n;i++){
        const p = document.createElement('div');
        p.className = 'burst';
        const a = Math.random()*Math.PI*2;
        const v = 1.5 + Math.random()*2.2;
        p.dataset.vx = (Math.cos(a)*v).toString();
        p.dataset.vy = (Math.sin(a)*v).toString();
        p.style.left = x+'px';
        p.style.top = y+'px';
        stage.appendChild(p);
        setTimeout(()=>p.remove(), 900);
      }
    }
    function coinRain(n=24){
      const W = stage.clientWidth;
      for(let i=0;i<n;i++){
        setTimeout(()=>{
          spawnFloat(Math.random()*W, -20, Math.random() < .15 ? 'üíé':'ü™ô');
        }, i*60);
      }
    }
    function loop(){
      const W = stage.clientWidth, H = stage.clientHeight;
      document.querySelectorAll('.burst').forEach(b=>{
        const vx = parseFloat(b.dataset.vx), vy = parseFloat(b.dataset.vy);
        const x = parseFloat(b.style.left), y = parseFloat(b.style.top);
        const ny = y + vy*6; const nx = x + vx*6;
        b.style.left = nx+'px'; b.style.top = ny+'px';
        b.style.opacity = Math.max(0, (parseFloat(b.style.opacity||'0.9') - 0.02)).toString();
      });

      for(let i=FLOATS.length-1;i>=0;i--){
        const f = FLOATS[i];
        f.t += 0.016;
        f.vy += 0.05;      // gravity
        f.x += Math.sin(f.t*1.5)*1.2; // Ê®™ÊåØ„Çå„ÅØÁ∏¶ÁîªÈù¢Âêë„Åë„Å´Êéß„Åà„ÇÅ
        f.y += f.vy*2.6;
        f.el.style.left = (f.x)+'px';
        f.el.style.top  = (f.y)+'px';
        if(f.y > H+60){ f.el.remove(); FLOATS.splice(i,1); }
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ===== leaderboard =====
    function renderLB(list){
      lbEl.innerHTML = '';
      list.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'lb-item';
        row.innerHTML = `
          <div class="rank">${idx+1}</div>
          <div class="uid">${escapeHtml(it.userId || 'anon')}</div>
          <div class="score">${Number(it.score||0).toLocaleString()}</div>
        `;
        lbEl.appendChild(row);
      });
    }

    // ===== socket & data =====
    const socket = io('/overlay', { transports:['websocket'], timeout: 8000, reconnection: true, reconnectionDelay: 800, reconnectionDelayMax: 4000 });
    socket.on('connect', ()=>{ connStatus.textContent='connected'; connStatus.style.color = 'var(--good)'; });
    socket.on('disconnect', ()=>{ connStatus.textContent='disconnected'; connStatus.style.color = 'var(--hot)'; });
    socket.on('connect_error', ()=>{ connStatus.textContent='error'; connStatus.style.color = 'var(--hot)'; });

    socket.on('hello', (p)=> log(`hello: ${new Date(p.ts).toLocaleTimeString()}`));
    socket.on('leaderboard:update', (top10)=> renderLB(top10 || []));

    // Êñ∞„Éö„Ç§„É≠„Éº„Éâ( spin )„Å´„ÇÇÂØæÂøú
    const TIER = {
      MISS:   { stop:'‚≠ê',  burst:10, rain:8,  banner:'TRY AGAIN', color:'var(--muted)' },
      NORMAL: { stop:'üéÅ',  burst:16, rain:18, banner:'HIT!',      color:'var(--acc2)' },
      HIGH:   { stop:'üíé',  burst:22, rain:28, banner:'BIG HIT!',  color:'var(--acc)'  },
      MEGA:   { stop:'üíé',  burst:28, rain:44, banner:'MEGA HIT!', color:'var(--hot)'  },
    };

    socket.on('play:event', async (payload)=>{
      try{
        if (payload && payload.spin) {
          const { tier, symbols, multiplier, bonusGame, comboExtend } = payload.spin;
          if (comboExtend) onComboHit(); else { comboMul = 1.0; comboEl.querySelector('.x').textContent = 'x1.0'; }
          addJackpot((payload.jpDelta||0) + (payload.score||0));

          await spinSlot(TIER[tier]?.stop || '‚≠ê');
          if (Array.isArray(symbols) && symbols.length === 3) {
            reelCells.forEach((c,i)=> c.textContent = symbols[i]);
          }

          const r = stage.getBoundingClientRect();
          spawnBurst(r.left + r.width*0.5, r.top + r.height*0.42, TIER[tier]?.burst ?? 16);
          coinRain(TIER[tier]?.rain ?? 16);
          banner.textContent = TIER[tier]?.banner || 'HIT!';
          banner.style.color = TIER[tier]?.color || '#fff';
          banner.style.display = 'block';
          setTimeout(()=> banner.style.display='none', 900);

          log(`+${(payload.score||0)}  ${payload.userId||'anon'}  [${tier}] x${(multiplier||1).toFixed(2)}  jp:+${payload.jpDelta||0}`);

          if (bonusGame) {
            setTimeout(()=>{
              coinRain(60);
              spawnBurst(r.left + r.width*0.5, r.top + r.height*0.42, 36);
            }, 400);
          }
          return;
        }

        // ÊóßÂΩ¢Âºè„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        const { userId, fallen=0, bonus=0, jpDelta=0, score=0 } = payload || {};
        onComboHit();
        addJackpot((jpDelta||0) + (score||0));
        await spinSlot(fallen >= 3 || bonus > 0 ? 'üíé' : '‚≠ê');
        const r = stage.getBoundingClientRect();
        spawnBurst(r.left + r.width*0.5, r.top + r.height*0.42, 24);
        coinRain(clamp(8 + Math.floor(fallen*1.2) + (bonus>0?12:0), 8, 60));
        log(`+${(score||0)}  ${userId || 'anon'}  (fallen:${fallen}, bonus:${bonus}, jp:+${jpDelta||0})`);
      }catch(e){
        console.error(e);
      }
    });

    // ÂàùÊúü„É≠„Éº„Éâ
    fetch('/overlay/state').then(r=>r.json()).then(d=> renderLB(d.top10 || [])).catch(()=>{});

    function log(s){
      const lines = (logEl.textContent || '').split('\n').filter(Boolean).slice(-18);
      lines.push(s);
      logEl.textContent = lines.join('\n');
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // JP„É°„Éº„Çø„ÉºÁ∑©„ÇÑ„ÅãÊ∏õË°∞
    setInterval(()=> {
      jpValue = clamp(jpValue - 0.002, 0, 1);
      jpFill.style.width = (jpValue*100).toFixed(1) + '%';
    }, 200);
  </script>
</body>
</html>
