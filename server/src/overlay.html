<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>TikTok Live: COIN FEVER ‚Äî PixiJS Portrait Slot</title>
  <style>
    :root{
      --bg:#05060a; --text:#eaf1ff; --muted:#93a0b4;
      --acc:#00e5a8; --acc2:#5b8cff; --hot:#ff4d67; --good:#38ef7d;
      --panel:#0d111a; --line:#171f2e;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    .frame{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:max(8px, env(safe-area-inset-top,8px));}
    .phone{
      width:min(100vw,56.25vh); height:min(177.78vw,100vh); aspect-ratio:9/16;
      border:1px solid var(--line); border-radius:20px;
      background: linear-gradient(180deg,#070b12,#05080e);
      overflow:hidden; display:grid; grid-template-rows:auto auto 1fr auto auto; gap:10px; padding:10px;
    }
    .bar{display:grid; gap:8px; grid-template-columns:1fr auto; align-items:center; padding:10px 12px; border:1px solid var(--line); border-radius:14px; background:linear-gradient(180deg,#0b1120,#090e18); box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
    .title{font-weight:800; letter-spacing:.4px; font-size:14px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0e1525; border:1px solid #1a2436; color:#cbd5e1; font-size:11px; white-space:nowrap}
    .meter{position:relative; height:12px; border-radius:999px; background:#0a0f18; border:1px solid #182032; overflow:hidden}
    .meter .fill{position:absolute; inset:0; width:0%; background:linear-gradient(90deg,#1240ff,#4dd4ff,#00e5a8); filter:brightness(1.15); transition:width .35s cubic-bezier(.2,.8,.2,1)}
    .subbar{display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:12px; background:linear-gradient(180deg,#0b1018,#090e18);}
    .stage{position:relative; border:1px solid var(--line); border-radius:16px; overflow:hidden;
      background: radial-gradient(60% 30% at 50% 10%, rgba(16,24,48,.6), transparent 70%), radial-gradient(90% 80% at 50% 100%, #05080f, #05060a 60%);}
    .stage::after{content:""; position:absolute; inset:-20% -10% auto -10%; height:60%; background: conic-gradient(from 180deg at 50% 0%, rgba(255,255,255,.045), rgba(255,255,255,0) 30%, rgba(255,255,255,.045) 60%, rgba(255,255,255,0)); mix-blend-mode: overlay; pointer-events:none; filter: blur(18px);}
    .panel{background:linear-gradient(180deg,#0b1018,#080c12); border:1px solid #172235; border-radius:14px; padding:10px}
    .panel h3{margin:0 0 6px 0; font-size:14px}
    .lb-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:10px}
    .lb-item:nth-child(odd){background:rgba(255,255,255,.03)}
    .rank{width:22px; text-align:center; color:#a5b4c3; font-size:12px}
    .uid{flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:12px}
    .score{font-weight:700; color:#e8eef7; font-size:12px}
    .log{font-size:11px; color:#aab3c2; white-space:pre-line; max-height:18vh; overflow:auto}
    .combo{position:absolute; right:10px; top:10px; background:rgba(0,0,0,.35); border:1px solid #1b2436; border-radius:12px; padding:6px 10px; font-weight:800; font-size:13px; z-index:3}
    .combo .x{color:#ff4d67}
    .banner{position:absolute; left:50%; top:6%; transform:translateX(-50%); padding:8px 14px; border-radius:12px; background:rgba(0,0,0,.5); border:1px solid #1b2333; font-weight:900; box-shadow:0 8px 30px rgba(0,0,0,.4); font-size:14px; z-index:3; display:none}
  </style>
</head>
<body>
  <div class="frame">
    <div class="phone">
      <!-- 1: „Çø„Ç§„Éà„É´„Éê„Éº -->
      <div class="bar">
        <div class="title">üé∞ COIN FEVER ‚Äî Casino Style</div>
        <div class="pill">Socket: <span id="conn-status">connecting...</span></div>
      </div>

      <!-- 2: ÈÄ≤Êçó„Éê„ÉºÔºàBONUS / JPÔºâ -->
      <div class="subbar">
        <div class="pill">BONUS <span id="bonus-text">0 / 10</span></div>
        <div class="pill">JP <span id="jp-text">0%</span></div>
        <div style="grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div class="meter"><div class="fill" id="bonus-fill"></div></div>
          <div class="meter"><div class="fill" id="jp-fill"></div></div>
        </div>
      </div>

      <!-- 3: „Çπ„ÉÜ„Éº„Ç∏ -->
      <div class="stage" id="stage">
        <div class="combo" id="combo">COMBO <span class="x">x1.0</span></div>
        <div class="banner" id="banner"></div>
      </div>

      <!-- 4: „É©„É≥„Ç≠„É≥„Ç∞ -->
      <div class="panel">
        <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞ Top10Ôºà‰ªäÊó•Ôºâ</h3>
        <div id="lb"></div>
      </div>

      <!-- 5: „É≠„Ç∞ -->
      <div class="panel">
        <h3>üéØ ÊúÄËøë„ÅÆ„Éí„ÉÉ„Éà</h3>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/pixi.js@7.4.0/dist/pixi.min.js" crossorigin="anonymous"></script>

  <script>
  // ===== DOM =====
  const $ = (s)=>document.querySelector(s);
  const stageEl = $('#stage'), connStatus = $('#conn-status'), lbEl = $('#lb'), logEl = $('#log');
  const bonusFill = $('#bonus-fill'), bonusText = $('#bonus-text');
  const jpFill = $('#jp-fill'), jpText = $('#jp-text');
  const banner = $('#banner'), comboEl = $('#combo');
  const clamp=(v,min,max)=>Math.max(min, Math.min(max, v));
  const log=(s)=>{ const lines=(logEl.textContent||'').split('\n').filter(Boolean).slice(-18); lines.push(s); logEl.textContent = lines.join('\n'); };

  // ===== Pixi App =====
  const app = new PIXI.Application({ resizeTo: stageEl, backgroundAlpha:0, antialias:true, powerPreference:'high-performance' });
  stageEl.appendChild(app.view);
  const root = new PIXI.Container(); app.stage.addChild(root);
  const bgLayer = new PIXI.Container(); const reelLayer = new PIXI.Container(); const fxLayer = new PIXI.Container();
  root.addChild(bgLayer, reelLayer, fxLayer);

  // ===== BG =====
  function drawBG(){
    bgLayer.removeChildren();
    const {width:w, height:h} = app.renderer;
    const grad = new PIXI.Graphics(); grad.beginFill(0x0b1322, 0.9).drawRoundedRect(0,0,w,h,18).endFill(); grad.alpha = 0.25; bgLayer.addChild(grad);
    for (let i=0;i<30;i++){
      const p = new PIXI.Graphics(); p.beginFill(0xffffff, Math.random()*0.15+0.05).drawCircle(0,0, Math.random()*1.5+0.8).endFill();
      p.x = Math.random()*w; p.y = Math.random()*h; p.alpha *= .5; p.blendMode = PIXI.BLEND_MODES.SCREEN; p.speed = (Math.random()*0.2+0.05); bgLayer.addChild(p);
    }
  }
  drawBG();
  app.ticker.add(()=>{ for (const p of bgLayer.children.slice(1)) { p.y -= p.speed; if (p.y < -10) p.y = app.renderer.height + 10; }});

  // ===== SymbolsÔºàatlas ‚Üí emoji „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ =====
  const SYMBOLS = [
    {ch:'ü™ô',c:0xffd54a,name:'coin'},
    {ch:'‚≠ê',c:0xfff9a6,name:'star'},
    {ch:'üéÅ',c:0xff7fb0,name:'gift'},
    {ch:'üî•',c:0xff694a,name:'fire'},
    {ch:'üíé',c:0x7fd4ff,name:'gem'},
    {ch:'üçÄ',c:0x6aff92,name:'clover'}
  ];

  let atlas = null;
  const textures = {};
  async function loadAtlasIfAny(){
    try{
      const res = await fetch('/assets/symbols.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('no atlas');
      atlas = await res.json();
      const base = await PIXI.Assets.load('/assets/symbols.png');
      for (const s of SYMBOLS){
        const f = atlas.frames?.[`${s.name}.png`];
        if (!f) throw new Error('atlas missing frame '+s.name);
        const rect = new PIXI.Rectangle(f.frame.x, f.frame.y, f.frame.w, f.frame.h);
        textures[s.ch] = new PIXI.Texture({ source: base.source, frame: rect });
      }
      console.info('atlas loaded');
      return true;
    }catch(e){
      console.info('atlas not found, fallback to emoji');
      return false;
    }
  }
  function makeEmojiTexture(ch, color){
    const c = new PIXI.Container();
    const bg = new PIXI.Graphics().beginFill(0x0e1626).drawRoundedRect(0,0,220,220,26).endFill();
    bg.lineStyle(3,0x1c2a48,1).drawRoundedRect(1.5,1.5,217,217,24);
    const txt = new PIXI.Text(ch,{fontFamily:'Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, system-ui, sans-serif', fontSize:120, align:'center'}); txt.anchor.set(.5); txt.x=110; txt.y=110;
    const glow = new PIXI.Graphics().beginFill(color, .18).drawCircle(110,110,80).endFill(); glow.blurFilter = new PIXI.filters.BlurFilter(18); glow.filters=[glow.blurFilter];
    c.addChild(bg, glow, txt);
    const rt = app.renderer.generateTexture(c, {resolution:2, scaleMode:PIXI.SCALE_MODES.LINEAR});
    c.destroy({children:true, texture:true, baseTexture:true});
    return rt;
  }
  async function ensureTextures(){
    const ok = await loadAtlasIfAny();
    if (ok) return;
    for (const s of SYMBOLS) textures[s.ch] = makeEmojiTexture(s.ch, s.c);
  }

  // ===== GeometryÔºàportraitÔºâ =====
  const REEL_W = 240, REEL_H = 240;   // 1„Çª„É´
  const GAP = 14;
  const SLOT_TARGET_W_RATIO = 0.90, SLOT_TARGET_H_RATIO = 0.42;
  const SLOT_SCALE_MIN = 0.55, SLOT_SCALE_MAX = 1.60;
  const SLOT_W_ABS_MAX = 720,       SLOT_H_ABS_MAX = 420;

  const reelMask = new PIXI.Graphics(); const reels = [];
  function layoutReels(){
    reelLayer.removeChildren();
    const {width:W, height:H} = app.renderer;

    const baseW = REEL_W*3 + GAP*2;
    const baseH = REEL_H;

    const targetW = Math.min(W * SLOT_TARGET_W_RATIO, SLOT_W_ABS_MAX);
    const targetH = Math.min(H * SLOT_TARGET_H_RATIO, SLOT_H_ABS_MAX);

    const scaleX = targetW / baseW, scaleY = targetH / baseH;
    const scale = Math.max(SLOT_SCALE_MIN, Math.min(SLOT_SCALE_MAX, Math.min(scaleX, scaleY)));

    const slotW = baseW * scale, slotH = baseH * scale;

    const slot = new PIXI.Container();
    slot.x = Math.floor((W - slotW)/2);
    slot.y = Math.floor((H - slotH)/2);
    slot.scale.set(scale);
    reelLayer.addChild(slot);

    const frame = new PIXI.Graphics();
    frame.lineStyle(8,0x1a2b4a,1).beginFill(0x0e1522).drawRoundedRect(-12,-12,baseW+24,baseH+24,22).endFill();
    frame.filters=[new PIXI.filters.BlurFilter(1.5)];
    slot.addChild(frame);

    reelMask.clear();
    reelMask.beginFill(0xffffff).drawRoundedRect(0,0,baseW,baseH,16).endFill();
    const view = new PIXI.Container(); view.mask = reelMask; view.addChild(reelMask); slot.addChild(view);

    reels.length = 0;
    for (let i=0;i<3;i++){
      const rc = new PIXI.Container(); rc.x = i*(REEL_W+GAP); rc.y=0; view.addChild(rc);
      const order = [...SYMBOLS.map(s=>s.ch), ...SYMBOLS.map(s=>s.ch)]; // 2Âë®
      let y = -REEL_H*order.length*0.5; // [-half, +half)
      for (const ch of order){
        const spr = new PIXI.Sprite(textures[ch]);
        spr.x=(REEL_W - spr.width)/2; spr.y=y; rc.addChild(spr); y += REEL_H;
      }
      reels.push({c: rc, vy: 0, spinning:false});
    }

    const gloss = new PIXI.Graphics();
    gloss.lineStyle(2,0x2e4578,1);
    gloss.moveTo(REEL_W+GAP/2, -6).lineTo(REEL_W+GAP/2, baseH+6);
    gloss.moveTo(REEL_W*2+GAP*1.5, -6).lineTo(REEL_W*2+GAP*1.5, baseH+6);
    slot.addChild(gloss);
  }

  // ===== Spin controlÔºàwrap/snap ÂÆâÂÆöÔºâ =====
  const randChoice=arr=>arr[(Math.random()*arr.length)|0];

  function advance(dt){
    for (const r of reels){
      if (!r.spinning) continue;
      const rc = r.c;
      const n = rc.children.length;
      const colH = n * REEL_H;
      const half = colH * 0.5;
      for (const spr of rc.children){
        spr.y += r.vy * dt;
        if (spr.y > half) spr.y -= colH; // ‰∏ÄÊñπÂêë„É©„ÉÉ„Éó
      }
    }
  }

  async function spinReels(finalSymbols=null){
    for (let i=0;i<3;i++){ const r=reels[i]; r.spinning=true; r.vy = 48 + i*4; }
    const accel=400, t0=performance.now(); while (performance.now()-t0<accel){ advance(1); await new Promise(r=>requestAnimationFrame(r)); }
    const steady=300+Math.random()*200, t1=performance.now(); while (performance.now()-t1<steady){ advance(1); await new Promise(r=>requestAnimationFrame(r)); }
    const finals = finalSymbols && finalSymbols.length===3 ? finalSymbols : [randChoice(SYMBOLS).ch, randChoice(SYMBOLS).ch, randChoice(SYMBOLS).ch];
    for (let i=0;i<3;i++){ await stopReelTo(i, finals[i]); }
    return finals;
  }

  function nearestTop(rc){
    let bestSpr=null, bestDist=1e9, idx=0;
    rc.children.forEach((spr,i)=>{
      const d = Math.abs(spr.y);
      if (d < bestDist){ bestSpr=spr; bestDist=d; idx=i; }
    });
    return { spr: bestSpr, symIdx: idx % SYMBOLS.length };
  }

  async function stopReelTo(i,ch){
    const r = reels[i];
    const targetIdx = SYMBOLS.findIndex(s=>s.ch===ch);
    const easeOut = t => 1 - Math.pow(1-t, 2.2);
    const startVy = r.vy;
    const dur = 700 + i*130;

    const t0 = performance.now();
    return new Promise(resolve=>{
      function step(){
        const t = (performance.now()-t0)/dur;
        if (t >= 1){
          r.vy = 0; r.spinning = false;

          const { spr: topSpr, symIdx: topSymIdx } = nearestTop(r.c);
          const diff = (targetIdx - topSymIdx + SYMBOLS.length) % SYMBOLS.length;
          const adjust = diff * REEL_H;
          r.c.children.forEach(s => { s.y -= adjust; });

          const off = topSpr.y - adjust;           // top „Çí y=0 „Å´ÊèÉ„Åà„Çã
          r.c.children.forEach(s => { s.y -= off; });

          r.c.children.forEach(s => {              // „Ç∞„É™„ÉÉ„Éâ„Å∏„Çπ„Éä„ÉÉ„Éó
            s.y = Math.round(s.y / REEL_H) * REEL_H;
          });

          bounceReel(i);
          return resolve();
        }
        r.vy = startVy * (1 - easeOut(t)) + 2.2;
        advance(1);
        requestAnimationFrame(step);
      }
      step();
    });
  }

  function bounceReel(i){
    const r = reels[i].c;
    const D1 = 80, D2 = 100;
    const sy0 = 1.0, sy1 = 0.92;
    const t0 = performance.now();
    (function step(){
      const t = performance.now() - t0;
      if (t >= D1 + D2){ r.scale.y = 1; return; }
      if (t < D1){ const p = t / D1; r.scale.y = sy0 + (sy1 - sy0)*p; }
      else { const p = (t - D1) / D2; r.scale.y = sy1 + (sy0 - sy1)*p; }
      requestAnimationFrame(step);
    })();
  }

  // ===== FXÔºàÊºîÂá∫Âº∑Â∫¶ FX_LEVEL „Åß„Çπ„Ç±„Éº„É´Ôºâ =====
  let FX_LEVEL = 1.0; // 0.3„Äú1.5
  function sparkleBurst(x,y,n=24,color=0x66ccff){
    n = Math.max(6, Math.floor(n * FX_LEVEL));
    for (let i=0;i<n;i++){
      const dot=new PIXI.Graphics(); dot.beginFill(0xffffff).drawCircle(0,0,Math.random()*1.8+0.7).endFill();
      const spr=new PIXI.Sprite(app.renderer.generateTexture(dot));
      spr.x=x; spr.y=y; spr.tint=color; spr.alpha=.9; spr.blendMode=PIXI.BLEND_MODES.ADD;
      spr.vx=(Math.random()*2-1)*(3+Math.random()*3); spr.vy=(Math.random()*2-1)*(3+Math.random()*3);
      spr.vr=(Math.random()*2-1)*.12; spr.life=36+(Math.random()*12|0); fxLayer.addChild(spr);
    }
  }
  function coinRain(count=30){
    count = Math.max(4, Math.floor(count * FX_LEVEL));
    const {width:W}=app.renderer;
    for (let i=0;i<count;i++){
      setTimeout(()=>{
        const t=new PIXI.Text('ü™ô',{fontSize:32});
        t.x=Math.random()*W; t.y=-20; t.vy=2+Math.random()*2.5; t.vx=(Math.random()*2-1)*.6;
        t.blendMode=PIXI.BLEND_MODES.SCREEN; t.alpha=.92; fxLayer.addChild(t);
        t.update=()=>{ t.x+=t.vx; t.y+=t.vy; t.vy+=.04; if(t.y>app.renderer.height+40){ t.destroy(); } };
      }, i*40);
    }
  }
  function screenFlash(ms=260){
    const r=new PIXI.Graphics().beginFill(0xffffff,.9).drawRect(0,0,app.renderer.width,app.renderer.height).endFill();
    fxLayer.addChild(r); const t0=performance.now();
    (function step(){ const t=(performance.now()-t0)/ms; if (t>=1){ r.destroy(); return; } r.alpha = .9*(1-t); requestAnimationFrame(step); })();
  }
  app.ticker.add(()=>{ for (const s of fxLayer.children){ if (s.life!==undefined){ s.x+=s.vx; s.y+=s.vy; s.rotation+=s.vr; s.alpha-=.02; s.life--; if (s.life<=0||s.alpha<=0) s.destroy(); } else if (s.update){ s.update(); } } });

  // ===== Combo & JP meter =====
  let jpValue=0; const addJackpot=(deltaScore)=>{ jpValue = clamp(jpValue + deltaScore/6000, 0, 1); const p=(jpValue*100); jpFill.style.width=p.toFixed(1)+'%'; jpText.textContent=p.toFixed(0)+'%'; };
  setInterval(()=>{ jpValue = clamp(jpValue - 0.0025, 0, 1); const p=(jpValue*100); jpFill.style.width=p.toFixed(1)+'%'; jpText.textContent=p.toFixed(0)+'%'; }, 220);
  let lastHitAt=0, comboMul=1.0;
  function onComboHit(extend=true){
    const t=performance.now(); const dt=(t-lastHitAt)/1000; lastHitAt=t;
    if (extend && dt<2.5) comboMul=clamp(comboMul+0.25,1,5); else if(!extend) comboMul=1.0;
    comboEl.querySelector('.x').textContent='x'+comboMul.toFixed(1);
    comboEl.animate([{transform:'scale(1.0)'},{transform:'scale(1.12)'},{transform:'scale(1.0)'}],{duration:260, easing:'ease-out'});
  }
  function showBanner(text,color){
    banner.textContent=text; banner.style.color=color||'#fff'; banner.style.display='block';
    banner.animate([{opacity:0, transform:'translate(-50%,-6px)'},{opacity:1, transform:'translate(-50%,0)'}],{duration:220,easing:'ease-out'});
    setTimeout(()=>banner.style.display='none', 900);
  }

  // ===== Leaderboard =====
  function renderLB(list){
    lbEl.innerHTML='';
    (list||[]).forEach((it,idx)=>{
      const row=document.createElement('div'); row.className='lb-item';
      row.innerHTML=`<div class="rank">${idx+1}</div><div class="uid">${escapeHtml(it.userId||'anon')}</div><div class="score">${Number(it.score||0).toLocaleString()}</div>`;
      lbEl.appendChild(row);
    });
  }
  const escapeHtml=(s)=>String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));

  // ===== Socket / QueueÔºàÁõ¥ÂàóÂåñÔºâ =====
  const socket = io('/overlay', { transports:['websocket'], timeout:8000, reconnection:true, reconnectionDelay:800, reconnectionDelayMax:4000 });
  socket.on('connect', ()=>{ connStatus.textContent='connected'; connStatus.style.color='var(--good)'; });
  socket.on('disconnect', ()=>{ connStatus.textContent='disconnected'; connStatus.style.color='var(--hot)'; });
  socket.on('connect_error', ()=>{ connStatus.textContent='error'; connStatus.style.color='var(--hot)'; });
  socket.on('hello', (p)=> log(`hello: ${new Date(p.ts).toLocaleTimeString()}`));
  socket.on('leaderboard:update', (top10)=> renderLB(top10 || []));

  const TIER = {
    MISS:   { stop:'‚≠ê',  burst:12, rain:10, banner:'TRY AGAIN', color:'#9aa7bd' },
    NORMAL: { stop:'üéÅ',  burst:18, rain:22, banner:'HIT!',      color:'#7bb0ff' },
    HIGH:   { stop:'üíé',  burst:26, rain:32, banner:'BIG HIT!',  color:'#00e5a8' },
    MEGA:   { stop:'üíé',  burst:36, rain:56, banner:'MEGA HIT!', color:'#ff4d67' },
  };

  const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
  const eventQueue = [];
  let draining = false;
  let PACE_MS = 180; // „É™„É¢„Éº„ÉàË®≠ÂÆö„ÅßÂ§âÊõ¥ÂèØËÉΩ

  function enqueue(kind, payload){
    if (kind === 'bonus' && eventQueue.length >= 1) eventQueue.splice(1, 0, { kind, payload });
    else eventQueue.push({ kind, payload });
    if (!draining) drainQueue();
  }
  async function drainQueue(){
    draining = true;
    while (eventQueue.length){
      const job = eventQueue.shift();
      if (job.kind === 'event')      await handlePlayEvent(job.payload);
      else if (job.kind === 'bonus') await handleBonus(job.payload);
      await sleep(PACE_MS);
    }
    draining = false;
  }

  async function handlePlayEvent(payload){
    try{
      if (payload && payload.spin) {
        const { tier, symbols, multiplier, bonusGame, comboExtend } = payload.spin;
        onComboHit(comboExtend!==false);
        addJackpot((payload.jpDelta||0) + (payload.score||0));
        await spinReels(Array.isArray(symbols)&&symbols.length===3 ? symbols : null);
        const cx=app.renderer.width/2, cy=app.renderer.height/2;
        sparkleBurst(cx, cy-10, TIER[tier]?.burst ?? 18, (TIER[tier]?.color ? PIXI.utils.string2hex(TIER[tier].color) : 0x66ccff));
        coinRain(TIER[tier]?.rain ?? 20);
        showBanner(TIER[tier]?.banner || 'HIT!', TIER[tier]?.color || '#fff');
        if (tier==='MEGA' || bonusGame){ setTimeout(()=>{ coinRain(60); sparkleBurst(cx, cy-12, 48, 0xffe066); }, 300); }
        log(`+${(payload.score||0)}  ${payload.userId||'anon'}  [${tier}] x${(multiplier||1).toFixed(2)}  jp:+${payload.jpDelta||0}`);
        return;
      }
      // ÊóßÂΩ¢Âºè
      const { userId, fallen=0, bonus=0, jpDelta=0, score=0 } = payload || {};
      onComboHit(true); addJackpot((jpDelta||0) + (score||0));
      await spinReels(fallen >= 3 || bonus > 0 ? ['üíé','üíé','üíé'] : null);
      const r = app.renderer; sparkleBurst(r.width/2, r.height/2-10, 24, 0x66ccff);
      coinRain(clamp(8 + Math.floor(fallen*1.2) + (bonus>0?12:0), 8, 60));
      showBanner((fallen>=3||bonus>0)?'HIT!':'TRY AGAIN', (fallen>=3||bonus>0)?'#00e5a8':'#9aa7bd');
      log(`+${(score||0)}  ${userId || 'anon'}  (fallen:${fallen}, bonus:${bonus}, jp:+${jpDelta||0})`);
    }catch(e){ console.error(e); }
  }

  async function handleBonus(p){
    try{
      const r = app.renderer, cx=r.width/2, cy=r.height/2;
      screenFlash(320);
      await spinReels(['üíé','üíé','üíé']);
      const backlog = eventQueue.length;
      coinRain(backlog > 5 ? 80 : 120);
      sparkleBurst(cx, cy-12, backlog > 5 ? 48 : 72, 0xffe066);
      showBanner(`GLOBAL BONUS +${p?.bonusScore||100} (by ${p?.userId||'anon'})`, '#ffcb4d');
      // „Éú„Éº„Éä„ÇπÈÅîÊàêÂæå„ÅÆË¶ã„ÅüÁõÆÂàùÊúüÂåñÔºàprogress „Ç§„Éô„É≥„Éà„ÇÇÊù•„Çã„ÅåÂç≥Êõ¥Êñ∞Ôºâ
      if (typeof lastThreshold === 'number') updateBonusProgress(0, lastThreshold);
      log(`üåü GLOBAL BONUS +${p?.bonusScore||100} triggered by ${p?.userId||'anon'} (threshold ${p?.threshold||10}, remain ${p?.remain ?? 0})`);
    }catch(e){ console.error(e); }
  }

  // Âèó‰ø°„ÅØÂøÖ„Åö„Ç≠„É•„Éº„Å∏
  socket.on('play:event', (payload)=> enqueue('event', payload));
  socket.on('play:bonus', (p)=> enqueue('bonus', p));

  // === ÈÄ≤ÊçóUI ===
  let lastThreshold = 10;
  function updateBonusProgress(done, thr){
    lastThreshold = thr;
    const pct = thr>0 ? (done / thr) * 100 : 0;
    bonusFill.style.width = Math.max(0, Math.min(100, pct)).toFixed(1)+'%';
    bonusText.textContent = `${done} / ${thr}`;
  }
  socket.on('bonus:progress', (p)=>{
    const thr = Number(p?.threshold || 10);
    const after = Number(p?.after || 0);
    const remain = Number(p?.remain || 0);
    const done = remain === 0 ? 0 : (thr - remain);
    updateBonusProgress(done, thr);
  });

  // === „É™„É¢„Éº„ÉàË®≠ÂÆöÔºàÂç≥ÊôÇÂèçÊò†Ôºâ ===
  socket.on('config:update', (cfg)=>{
    try{
      if (typeof cfg?.paceMs === 'number') PACE_MS = Math.max(80, Math.min(800, Math.floor(cfg.paceMs)));
      if (typeof cfg?.fxLevel === 'number') FX_LEVEL = Math.max(0.3, Math.min(1.5, Number(cfg.fxLevel)));
      if (typeof cfg?.threshold === 'number') {
        const thr = Math.max(1, cfg.threshold|0);
        // ÊúÄÊñ∞„ÅÆ remain „ÇíÂèñ„ÇäÁõ¥„Åó„Å¶„É°„Éº„Çø„Éº„ÇíÂêåÊúü
        fetch('/bonus/state').then(r=>r.json()).then(b=>{
          const after = Number(b?.after || 0);
          const remain = Number(b?.remain || 0);
          const done = remain === 0 ? 0 : (thr - remain);
          updateBonusProgress(done, thr);
        }).catch(()=>{ updateBonusProgress(0, thr); });
      }
    }catch(e){ console.error(e); }
  });

  // ÂàùÊúü„É≠„Éº„ÉâÊôÇÔºö„É©„É≥„Ç≠„É≥„Ç∞„Å®ÈÄ≤Êçó„ÄÅ„ÉÜ„ÇØ„Çπ„ÉÅ„É£Ë™≠„ÅøËæº„Åø
  fetch('/overlay/state').then(r=>r.json()).then(d=> renderLB(d.top10 || [])).catch(()=>{});
  fetch('/bonus/state').then(r=>r.json()).then(b=>{
    const thr = Number(b?.threshold || 10);
    const remain = Number(b?.remain || 0);
    const done = remain === 0 ? 0 : (thr - remain);
    updateBonusProgress(done, thr);
  }).catch(()=>{});

  (async function init(){
    await ensureTextures();
    layoutReels();
    app.renderer.on('resize', layoutReels);
  })();
  </script>
</body>
</html>
