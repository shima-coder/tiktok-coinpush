<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TikTok Live: Coin Fever</title>
  <style>
    :root {
      --bg: #05060a; --panel: #0e1014; --panel2:#10131a;
      --text:#eef1f6; --muted:#9aa0a6; --acc:#00e5a8; --acc2:#5b8cff; --warn:#ffd166; --hot:#ff4d67;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto}
    .wrap{display:grid;grid-template-columns:1fr 320px;height:100%;}
    .stage{position:relative;overflow:hidden;background:radial-gradient(1200px 600px at 70% 30%, #0a0f1a, #05060a)}
    .side{background:linear-gradient(180deg,#0b0d12,#07080c);border-left:1px solid #171a22;padding:14px 12px;overflow:auto}
    h2{margin:4px 0 10px;font-size:18px}
    .lb-row{display:flex;align-items:center;gap:10px;padding:8px 6px;border-radius:10px;margin:6px 0;background:rgba(255,255,255,0.03);backdrop-filter: blur(4px)}
    .rank{width:22px;text-align:right;color:var(--muted)}
    .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .score{font-variant-numeric:tabular-nums}
    .meter-wrap{position:absolute;left:50%;top:10px;transform:translateX(-50%);width:min(820px,80%);background:#0c0f16;border:1px solid #161a24;border-radius:14px;box-shadow:0 10px 30px #0007}
    .meter-bar{height:16px;background:linear-gradient(90deg,var(--acc),var(--acc2));width:0%;border-radius:14px}
    .meter{padding:8px 12px}
    .meter-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:14px;color:#c7cfdb}
    .slot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%); width:min(640px,70%); aspect-ratio:16/9; border-radius:18px; background:linear-gradient(180deg,#0b0f17,#0a0c12); border:1px solid #151a24; box-shadow:0 30px 80px #0008; overflow:hidden}
    .slot-head{padding:10px 16px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#111726,#0e1320); border-bottom:1px solid #171d2b}
    .slot-title{font-weight:800;letter-spacing:.5px}
    .slot-reel{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px; padding:18px}
    .cell{height:120px;border-radius:16px;background:linear-gradient(145deg,#121826,#0a0f1a); border:1px solid #1a2233; display:flex; align-items:center;justify-content:center; font-size:44px}
    .slot-foot{display:flex;gap:10px;align-items:center;padding:10px 16px;border-top:1px solid #151a24;font-size:14px;color:#c7cfdb}
    .pill{border:1px solid #1b2230; background:#0c111a; border-radius:999px; padding:4px 10px}
    .combo{color:#000;background:var(--warn);font-weight:800}
    .toast{position:absolute; left:50%; top:18%; transform:translateX(-50%); padding:12px 18px; background:#0e121a; border:1px solid #1b2230; border-radius:12px; color:#fff; box-shadow:0 10px 30px #0008; font-size:18px; opacity:0; transition:opacity .2s, transform .2s; pointer-events:none}
    .toast.show{opacity:1; transform:translateX(-50%) scale(1.02)}
    canvas.particles{position:absolute; inset:0; pointer-events:none;}
    .floating{position:absolute; color:#fff; font-weight:800; text-shadow:0 6px 24px #000; pointer-events:none}
    .streak{color:#000;background:var(--hot);padding:2px 8px;border-radius:999px;margin-left:8px;font-weight:800}
    .dim{color:#a8b0be}
  </style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <div class="meter-wrap">
      <div class="meter">
        <div class="meter-head"><div>JACKPOT POOL</div><div id="meterText" class="dim">0%</div></div>
        <div class="meter-bar" id="meterBar"></div>
      </div>
    </div>

    <div class="slot" id="slot">
      <div class="slot-head">
        <div class="slot-title">COIN FEVER</div>
        <div class="pill" id="lastUser">‚Äî</div>
      </div>
      <div class="slot-reel" id="reel">
        <div class="cell" id="c1">üí∞</div>
        <div class="cell" id="c2">‚≠êÔ∏è</div>
        <div class="cell" id="c3">üçÄ</div>
      </div>
      <div class="slot-foot">
        <div class="pill">+<span id="lastScore">0</span> pt</div>
        <div class="pill combo">COMBO x<span id="combo">1</span></div>
        <div class="pill">MEDALS <span id="medals">0</span></div>
      </div>
    </div>

    <div id="toast" class="toast">+0</div>
    <canvas class="particles" id="fx" width="1920" height="1080"></canvas>
  </div>

  <aside class="side">
    <h2>Top 10 Today</h2>
    <div id="lb"></div>
  </aside>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  // ====== UI refs ======
  const lb = document.getElementById('lb');
  const toast = document.getElementById('toast');
  const meterBar = document.getElementById('meterBar');
  const meterText = document.getElementById('meterText');
  const lastUser = document.getElementById('lastUser');
  const lastScore = document.getElementById('lastScore');
  const medalsEl = document.getElementById('medals');
  const comboEl = document.getElementById('combo');
  const reel = document.getElementById('reel');
  const fx = document.getElementById('fx');
  const g = fx.getContext('2d');

  // ====== state ======
  let combo = 1, lastPlayAt = 0, jackpot = 0; // 0..1
  const EMOJIS = ['üí∞','‚≠êÔ∏è','üçÄ','üíé','üî•','üéâ','ü™ô','‚ö°Ô∏è'];
  const FLOATS = [];

  // ====== helpers ======
  const fmt = (n) => Math.round(n).toLocaleString('ja-JP');
  const esc = (s) => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
  const setMeter = (pct) => {
    jackpot = Math.max(0, Math.min(1, pct));
    meterBar.style.width = (jackpot*100).toFixed(0)+'%';
    meterText.textContent = (jackpot*100).toFixed(0)+'%';
  };

  // ====== particles / coin rain ======
  const P = [];
  function spawnBurst(x,y,n,kind='coin'){
    for(let i=0;i<n;i++){
      P.push({
        x, y,
        vx: (Math.random()-0.5)*8, vy: (Math.random()-0.8)*9,
        r: kind==='coin'? 4+Math.random()*3 : 2+Math.random()*2,
        life: 1, kind
      });
    }
  }
  function coinRain(n=60){
    for(let i=0;i<n;i++){
      P.push({ x: fx.width*(0.55+Math.random()*0.4), y: -10-Math.random()*200,
        vx: (Math.random()-0.5)*2, vy: 2+Math.random()*3, r: 3+Math.random()*3, life: 1.2, kind:'coin' });
    }
  }
  function stepFx(ts){
    g.clearRect(0,0,fx.width,fx.height);
    for(let i=P.length-1;i>=0;i--){
      const p=P[i];
      p.vy += 0.08;
      p.x += p.vx; p.y += p.vy;
      p.life -= 0.008;
      if(p.life<=0 || p.y>fx.height+20){ P.splice(i,1); continue; }
      g.beginPath();
      g.arc(p.x,p.y,p.r,0,Math.PI*2);
      if(p.kind==='coin'){ g.fillStyle = '#ffd166'; g.strokeStyle = '#b68b27'; g.lineWidth = 1; g.fill(); g.stroke(); }
      else { g.fillStyle = 'rgba(255,255,255,0.9)'; g.fill(); }
    }
    // floating texts
    for(let i=FLOATS.length-1;i>=0;i--){
      const f = FLOATS[i];
      f.el.style.transform = `translate(${f.x}px, ${f.y}px)`;
      f.y -= 0.5; f.t += 1/60;
      if(f.t>2){ f.el.remove(); FLOATS.splice(i,1); }
    }
    requestAnimationFrame(stepFx);
  }
  requestAnimationFrame(stepFx);

  function floatText(x,y,html,cls=''){
    const el = document.createElement('div');
    el.className = 'floating ' + cls;
    el.style.left = '0'; el.style.top = '0';
    el.style.transform = `translate(${x}px, ${y}px)`;
    el.innerHTML = html;
    document.body.appendChild(el);
    FLOATS.push({el, x, y, t:0});
  }

  // ====== slot animation ======
  function spinSlot(score){
    const cells = [...reel.children];
    const t0 = Date.now();
    const dur = 900;
    const id = setInterval(()=>{
      cells.forEach(c => c.textContent = EMOJIS[(Math.random()*EMOJIS.length)|0]);
      if(Date.now()-t0 > dur) { clearInterval(id); cells.forEach((c,i)=> c.textContent = ['üíé','üíé','üíé'][i] ); }
    }, 60);

    // burst
    spawnBurst(window.innerWidth*0.5, window.innerHeight*0.42, Math.min(120, 40+score/5));
  }

  // ====== Leaderboard ======
  async function refreshLB(){
    try{
      const res = await fetch('/overlay/state');
      const data = await res.json();
      lb.innerHTML = (data.top10||[]).map((e,i)=>(
        `<div class="lb-row"><div class="rank">${i+1}</div>`+
        `<div class="name">${esc(e.name||e.user||e[0]||'-')}</div>`+
        `<div class="score">${fmt(e.score||e[1]||0)}</div></div>`
      )).join('') || `<div class="lb-row"><div class="name">„Åæ„Å†„Çπ„Ç≥„Ç¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>`;
    }catch(e){ console.error(e); }
  }
  setInterval(refreshLB, 3000);
  refreshLB();

  // ====== Toast ======
  function showToast(text){
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1200);
  }

  // ====== play:event Âèó‰ø° ======
  const originWs = window.location.origin.replace(/^http/,'ws');
  const socket = io(`${originWs}/overlay`, { transports:['websocket'] });

  socket.on('hello', ()=> console.log('hello from server'));

  socket.on('play:event', (evt)=>{
    const now = Date.now();
    // comboÔºà2Áßí‰ª•ÂÜÖ„ÅÆÈÄ£Êâì„Åß‰º∏„Å≥„ÇãÔºâ
    combo = (now - lastPlayAt < 2000) ? Math.min(20, combo+1) : 1;
    lastPlayAt = now;
    comboEl.textContent = combo;

    const user = evt?.userId || 'user';
    const baseScore = Math.max(10, Math.floor(evt?.result?.score || 0));
    const score = Math.floor(baseScore * (1 + (combo-1)*0.08));
    const medals = Math.max(5, Math.floor(evt?.medals || 10));
    lastUser.textContent = user;
    lastScore.textContent = fmt(score);
    medalsEl.textContent = fmt(medals);

    // Ë¶ã„ÅüÁõÆ„ÅÆÊºîÂá∫
    showToast(`+${fmt(score)} pt`);
    spinSlot(score);
    coinRain(Math.min(120, medals*2));
    floatText(window.innerWidth*0.5-40, window.innerHeight*0.24, `+${fmt(score)} pt`, '');

    // „Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„Éà„É°„Éº„Çø„ÉºÔºàÁñë‰ººÔºöË≤Ø„Åæ„Å£„Å¶100%„ÅßËä±ÁÅ´Ôºâ
    const add = Math.min(0.15, medals/500); // „ÇÆ„Éï„ÉàÂº∑Â∫¶„Åß‰∏äÊòá
    setMeter(Math.min(1, jackpot + add));
    if(jackpot >= 0.999){
      // Â§ßÁàÜÁô∫
      for(let i=0;i<10;i++) spawnBurst(window.innerWidth*0.5, window.innerHeight*0.42, 80, 'spark');
      setMeter(0); // „É™„Çª„ÉÉ„Éà
      floatText(window.innerWidth*0.5-80, window.innerHeight*0.2, 'üéâ JACKPOT! üéâ', '');
    }

    // „É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞„ÇÇÂëº„Çì„Åß„Åä„Åè
    refreshLB();
  });

  // ÂàùÊúü„É°„Éº„Çø„ÉºÔºàÁñë‰ºº„Åß0%Ôºâ
  setMeter(0);
})();
</script>
</body>
</html>
