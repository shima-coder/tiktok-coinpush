<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>RETRO 777 — Live Overlay</title>
  <style>
    :root{
      --bg:#05060a; --text:#eaf1ff; --muted:#93a0b4;
      --hot:#ff4d67; --good:#38ef7d; --accent:#ffd54a; --blue:#5b8cff;
      --chrome1:#cfd8e3; --chrome2:#808b9c; --chrome3:#404a5a;
      --line:#1b2333;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--text);font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto}
    .frame{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:max(8px, env(safe-area-inset-top,8px));}

    /* ── 実機っぽい筐体レイアウト（9:16） ───────────────────────── */
    .cabinet{
      /* 片側のみ制約して aspect-ratio に任せる：常に正しい9:16 */
      aspect-ratio: 9 / 16;
      width: min(100vw, calc(100vh * 9 / 16)); /* 横は画面幅以内＆縦から計算 */
      /* height は aspect-ratio から自動算出 */

      display:grid; grid-template-rows: 64px 54px 1fr 120px 92px; gap:10px;
      background:linear-gradient(180deg,#0a0f16,#080c12);
      border-radius:22px; padding:10px;
      border:2px solid #000;
      box-shadow:
        0 0 0 4px #202634 inset,
        0 0 0 9px #0b0f18 inset,
        0 18px 40px rgba(0,0,0,.8);
      position:relative; overflow:hidden;
    }


    .bezel{position:absolute; inset:0; border-radius:22px; pointer-events:none;}
    .bezel::before{ /* クローム外枠の反射 */
      content:""; position:absolute; inset:0;
      border-radius:22px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0) 18%, rgba(255,255,255,.06) 40%, rgba(255,255,255,0) 60%) ;
      mix-blend-mode:screen; opacity:.6;
    }

    /* ── 上部ランプ（赤） ── */
    .marquee{
      border-radius:16px; border:1px solid #3c0b14; overflow:hidden;
      background:
        radial-gradient(110% 130% at 50% 20%, rgba(255,150,150,.5), rgba(255,0,0,.2) 50%, rgba(0,0,0,.0) 70%),
        linear-gradient(180deg,#ba001e,#690010);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.25), inset 0 -5px 18px rgba(0,0,0,.6);
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .marquee .txt{
      font-weight:900; letter-spacing:.8px; font-size:18px;
      text-shadow: 0 2px 0 #3a0010, 0 0 8px rgba(255,210,210,.6);
    }
    .marquee .spark{
      position:absolute; inset:0; background:
        repeating-linear-gradient(90deg, rgba(255,255,255,.12) 0 6px, rgba(255,255,255,0) 6px 12px);
      mix-blend-mode:overlay; opacity:.45; animation:scan 2.6s linear infinite;
    }
    @keyframes scan{ to{ transform: translateX(100%);} }

    /* ── ロゴ帯（黒） ── */
    .header-strip{
      border-radius:14px; border:1px solid #242b3a;
      background:linear-gradient(180deg,#0c0f17,#070a10);
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-weight:900; letter-spacing:.4px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }
    .header-strip .chip{font-size:18px; filter: drop-shadow(0 1px 2px rgba(255,255,255,.25));}

    /* ── 画面（ガラス） ── */
    .glass{
      position:relative; border-radius:16px; border:1px solid var(--line); overflow:hidden;
      background:
        radial-gradient(60% 28% at 50% 12%, rgba(18,26,48,.65), rgba(18,26,48,0) 70%),
        radial-gradient(90% 70% at 50% 100%, #070b12, #05060a 60%);
    }
    .chrome-top, .chrome-bottom{
      position:absolute; left:0; right:0; height:12px;
      background:linear-gradient(180deg, var(--chrome1), var(--chrome2) 50%, var(--chrome3));
      opacity:.35; filter:blur(.3px);
    }
    .chrome-top{ top:0 } .chrome-bottom{ bottom:0 }

    /* ── GOGO! ランプ ── */
    .gogo{ position:absolute; left:10px; bottom:10px; width:110px; height:72px;
      border-radius:12px; border:1px solid #1c2240; background:linear-gradient(180deg,#0d1130,#0a0f26);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05), 0 8px 20px rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center; text-align:center; line-height:1.05;
      font-weight:900; font-size:14px; color:#8aa4ff; letter-spacing:.4px;
    }
    .gogo .burst{
      position:absolute; inset:-10% -18% -10% -18%;
      background: radial-gradient(35% 35% at 50% 50%, rgba(120,180,255,.55), rgba(120,180,255,0));
      opacity:0; pointer-events:none;
    }
    .gogo.on{ color:#fff; border-color:#3156ff; }
    .gogo.on .burst{ opacity:1; animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:.6 }
      50%    { transform:scale(1.08); opacity:1 }
    }

    /* ── 下部操作パネル ── */
    .panel{
      border-radius:16px; border:1px solid #2a3145;
      background: linear-gradient(180deg,#0b1018,#090d14);
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding:10px 12px;
    }
    .buttons{
      display:flex; gap:18px; align-items:center; justify-content:center;
    }
    .btn{
      width:56px; height:56px; border-radius:50%;
      background: radial-gradient(60% 60% at 50% 35%, #ffb1b1, #e1002a 60%, #7a0016 85%);
      box-shadow: inset 0 2px 0 rgba(255,255,255,.5), inset 0 -8px 16px rgba(0,0,0,.35), 0 6px 14px rgba(0,0,0,.5);
      border:1px solid #3a000e; position:relative;
    }
    .btn::after{
      content:""; position:absolute; inset:8% 18% auto 18%; height:22%;
      background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,0));
      border-radius:80px;
    }
    .btn.press{ transform:translateY(2px); filter:brightness(.92) saturate(1.08); }

    .meters{
      display:grid; grid-template-columns: repeat(3, 88px); gap:10px;
    }
    .meter{
      border-radius:10px; padding:6px 8px; text-align:center;
      background:linear-gradient(180deg,#0c1020,#0a0e18);
      border:1px solid #1e2638; box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .meter .lbl{font-size:10px; color:#a8b4c6; letter-spacing:.2px}
    .meter .val{font-weight:900; font-size:20px; letter-spacing:.1em; color:#ff334f; text-shadow:0 0 8px rgba(255,60,90,.55)}
    .meter .val.green{ color:#5aff98; text-shadow:0 0 8px rgba(90,255,160,.55) }
    .meter .val.gold{ color:#ffd75a; text-shadow:0 0 8px rgba(255,220,120,.65) }

    /* ── ボトムロゴ（黒） ── */
    .footer{
      border-radius:16px; border:1px solid #242b3a;
      background:linear-gradient(180deg,#0c0f17,#070a10);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:20px; letter-spacing:1px;
      text-shadow:0 2px 0 #111, 0 0 10px rgba(255,255,255,.18);
    }

    /* ── 右下：ログ&ランキング（最小限） ── */
    .aux{
      position:absolute; right:10px; bottom:10px; width:38%;
      display:grid; gap:8px; pointer-events:none;
    }
    .panel-mini{
      background:linear-gradient(180deg,#0b1018,#080c12); border:1px solid #172235;
      border-radius:12px; padding:8px; pointer-events:auto;
    }
    .panel-mini h3{margin:0 0 4px 0; font-size:12px}
    .log{font:11px/1.35 ui-monospace, SFMono-Regular, Menlo, monospace; color:#aab3c2; max-height:13vh; overflow:auto; white-space:pre-line}
    .lb{max-height:20vh; overflow:auto}
    .lb-row{display:flex; justify-content:space-between; gap:8px; font-size:12px; padding:3px 4px; border-radius:8px}
    .lb-row:nth-child(odd){background:rgba(255,255,255,.03)}
    .lb-row .u{overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1}

    /* 演出：ボーナス時に全体がビカビカする */
    .cabinet.flash .marquee{ filter: brightness(1.2) saturate(1.2); }
    .cabinet.flash .marquee .txt{ text-shadow: 0 0 18px rgba(255,170,170,.9), 0 0 6px rgba(255,90,90,.9); }
  </style>
</head>
<body>
  <div class="frame">
    <div class="cabinet" id="cab">
      <div class="bezel"></div>

      <!-- 上部ランプ -->
      <div class="marquee">
        <div class="txt">★ BIG CHANCE! ★</div>
        <div class="spark"></div>
      </div>

      <!-- 黒帯ロゴ -->
      <div class="header-strip">
        <span class="chip">RETRO 777</span>
        <span style="opacity:.65;font-weight:800;">LIVE OVERLAY</span>
        <span style="margin-left:auto" class="pill">Socket: <span id="conn">connecting...</span></span>
      </div>

      <!-- 画面（Pixi） -->
      <div class="glass" id="stage">
        <div class="chrome-top"></div><div class="chrome-bottom"></div>
        <div class="gogo" id="gogo">
          <div class="burst"></div>
          <div>GOGO!<br>CHANCE</div>
        </div>
      </div>

      <!-- 操作パネル -->
      <div class="panel">
        <div class="buttons">
          <div class="btn" id="btnL" aria-hidden="true"></div>
          <div class="btn" id="btnC" aria-hidden="true"></div>
          <div class="btn" id="btnR" aria-hidden="true"></div>
        </div>
        <div class="meters">
          <div class="meter"><div class="lbl">CREDIT</div><div class="val gold" id="mCredit">000</div></div>
          <div class="meter"><div class="lbl">COUNT</div><div class="val" id="mCount">000</div></div>
          <div class="meter"><div class="lbl">BONUS</div><div class="val green" id="mBonus">0/10</div></div>
        </div>
      </div>

      <!-- 下部ロゴ -->
      <div class="footer">RETRO SLOT — LET'S PLAY</div>

      <!-- 補助：ログとランキング -->
      <div class="aux">
        <div class="panel-mini">
          <h3>🎯 Recent</h3>
          <div class="log" id="log"></div>
        </div>
        <div class="panel-mini">
          <h3>🏆 Top 10</h3>
          <div class="lb" id="lb"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/pixi.js@7.4.0/dist/pixi.min.js" crossorigin="anonymous"></script>

  <script>
  // ---------------- DOM refs ----------------
  const $ = s=>document.querySelector(s);
  const cab = $('#cab'), stageEl = $('#stage'), gogo = $('#gogo');
  const logEl = $('#log'), lbEl = $('#lb'), conn = $('#conn');
  const mCredit = $('#mCredit'), mCount = $('#mCount'), mBonus = $('#mBonus');
  const btnL = $('#btnL'), btnC = $('#btnC'), btnR = $('#btnR');
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const fmt3 = n => String(Math.max(0,Math.floor(n))).padStart(3,'0');
  function log(s){ const arr=(logEl.textContent||'').split('\n').filter(Boolean).slice(-16); arr.push(s); logEl.textContent = arr.join('\n'); }

  // ---------------- PIXI setup ----------------
  const app = new PIXI.Application({ resizeTo: stageEl, backgroundAlpha:0, antialias:true, powerPreference:'high-performance' });
  stageEl.appendChild(app.view);
  const root = new PIXI.Container(); app.stage.addChild(root);
  const bgLayer = new PIXI.Container(), reelLayer = new PIXI.Container(), fxLayer = new PIXI.Container();
  root.addChild(bgLayer, reelLayer, fxLayer);

  // Background particles (うっすら)
  function drawBG(){
    bgLayer.removeChildren();
    const {width:w, height:h}=app.renderer;
    const gel = new PIXI.Graphics().beginFill(0x0d1322,.25).drawRoundedRect(0,0,w,h,18).endFill();
    bgLayer.addChild(gel);
    for (let i=0;i<24;i++){
      const p=new PIXI.Graphics(); p.beginFill(0xffffff,Math.random()*.15+.04).drawCircle(0,0,Math.random()*1.6+.8).endFill();
      const s=new PIXI.Sprite(app.renderer.generateTexture(p)); s.x=Math.random()*w; s.y=Math.random()*h; s.alpha*=.6; s.v=(Math.random()*.2+.05);
      s.blendMode=PIXI.BLEND_MODES.SCREEN; bgLayer.addChild(s);
    }
  }
  drawBG();
  app.ticker.add(()=>{ for(const s of bgLayer.children.slice(1)){ s.y-=s.v; if(s.y<-10) s.y=app.renderer.height+10; } });

  // ---------------- Symbols ----------------
  // 7 と BAR はグラフィックで自前生成。他は絵文字のフォールバック。
  const SYMBOLS = [
    {ch:'7',  type:'seven', c:0xff2b3a},
    {ch:'BAR',type:'bar',   c:0xffffff},
    {ch:'🔔', c:0xffd24d},
    {ch:'🍒', c:0xff6b8a},
    {ch:'🍇', c:0x88ffb3},
    {ch:'⭐', c:0xfff9a6},
    {ch:'💎', c:0x7fd4ff},
    {ch:'🪙', c:0xffd54a},
  ];
  const textures = {};

  function makeSevenTexture(){
    const g = new PIXI.Container();
    const bg = new PIXI.Graphics()
      .beginLinearGradientFill([0x33050a,0x690010,0xba001e],[0,0.6,1],0,0,0,220)
      .drawRoundedRect(0,0,220,220,26).endFill();
    const border = new PIXI.Graphics().lineStyle(3,0x3a0010,1).drawRoundedRect(1.5,1.5,217,217,24);
    const txt = new PIXI.Text('7',{fontFamily:'Impact, Haettenschweiler, "Arial Black", sans-serif', fontSize:150, fill:0xfff6f0, stroke:0x8a0018, strokeThickness:6});
    txt.anchor.set(.5); txt.x=110; txt.y=116;
    g.addChild(bg,border,txt);
    const t=app.renderer.generateTexture(g,{resolution:2, scaleMode:PIXI.SCALE_MODES.LINEAR});
    g.destroy({children:true, texture:true, baseTexture:true}); return t;
  }
  function makeBarTexture(){
    const c=new PIXI.Container();
    const bg=new PIXI.Graphics()
      .beginLinearGradientFill([0x0b0f18,0x171e2d,0x0b0f18],[0,0.5,1],0,0,0,220)
      .drawRoundedRect(0,0,220,220,26).endFill();
    const rim=new PIXI.Graphics().lineStyle(3,0x1c2a48,1).drawRoundedRect(1.5,1.5,217,217,24);
    const plate=new PIXI.Graphics().beginFill(0x222b3c).drawRoundedRect(30,78,160,64,12).endFill();
    const txt=new PIXI.Text('BAR',{fontFamily:'Impact, Haettenschweiler, "Arial Black", sans-serif', fontSize:64, fill:0xffffff});
    txt.anchor.set(.5); txt.x=110; txt.y=110;
    c.addChild(bg,rim,plate,txt);
    const t=app.renderer.generateTexture(c,{resolution:2, scaleMode:PIXI.SCALE_MODES.LINEAR});
    c.destroy({children:true, texture:true, baseTexture:true}); return t;
  }
  function makeEmojiTexture(ch,color){
    const c=new PIXI.Container();
    const bg=new PIXI.Graphics().beginFill(0x0e1626).drawRoundedRect(0,0,220,220,26).endFill();
    bg.lineStyle(3,0x1c2a48,1).drawRoundedRect(1.5,1.5,217,217,24);
    const glow=new PIXI.Graphics().beginFill(color,.18).drawCircle(110,110,80).endFill();
    glow.filters=[new PIXI.filters.BlurFilter(18)];
    const txt=new PIXI.Text(ch,{fontFamily:'Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, system-ui', fontSize:120});
    txt.anchor.set(.5); txt.x=110; txt.y=110;
    c.addChild(bg,glow,txt);
    const t=app.renderer.generateTexture(c,{resolution:2, scaleMode:PIXI.SCALE_MODES.LINEAR});
    c.destroy({children:true, texture:true, baseTexture:true}); return t;
  }
  // 生成
  textures['7']   = makeSevenTexture();
  textures['BAR'] = makeBarTexture();
  for (const s of SYMBOLS){ if(!textures[s.ch]) textures[s.ch]=makeEmojiTexture(s.ch,s.c); }

  // ---------------- Slot Geometry ----------------
  const REEL_W=240, REEL_H=240, GAP=14;
  const TARGET_W_RATIO=.88, TARGET_H_RATIO=.46, SCALE_MIN=.55, SCALE_MAX=1.6;
  const reels=[]; const reelMask=new PIXI.Graphics();

  function layoutReels(){
    reelLayer.removeChildren();
    const {width:W,height:H}=app.renderer;
    const baseW=REEL_W*3+GAP*2, baseH=REEL_H;
    const targetW=W*TARGET_W_RATIO, targetH=H*TARGET_H_RATIO;
    const scale=clamp(Math.min(targetW/baseW,targetH/baseH),SCALE_MIN,SCALE_MAX);
    const slot=new PIXI.Container(); slot.scale.set(scale);
    slot.x=Math.floor((W-baseW*scale)/2); slot.y=Math.floor((H-baseH*scale)/2);
    reelLayer.addChild(slot);

    reelMask.clear().beginFill(0xffffff).drawRoundedRect(0,0,baseW,baseH,16).endFill();
    const view=new PIXI.Container(); view.mask=reelMask; view.addChild(reelMask); slot.addChild(view);

    reels.length=0;
    for(let i=0;i<3;i++){
      const rc=new PIXI.Container(); rc.x=i*(REEL_W+GAP); view.addChild(rc);
      const order=[...'777'.split(''), 'BAR','🔔','🍒','🍇','⭐','💎','🪙','BAR','🔔','🍒','🍇','⭐','💎','🪙']; // 長め
      let y=-REEL_H*order.length*.5;
      for(const ch of order){ const sp=new PIXI.Sprite(textures[ch] || textures['⭐']); sp.x=(REEL_W-sp.width)/2; sp.y=y; rc.addChild(sp); y+=REEL_H; }
      reels.push({c:rc, vy:0, spinning:false});
    }

    // 仕切り線
    const gloss=new PIXI.Graphics().lineStyle(2,0x2e4578,1);
    gloss.moveTo(REEL_W+GAP/2, -6).lineTo(REEL_W+GAP/2, baseH+6);
    gloss.moveTo(REEL_W*2+GAP*1.5, -6).lineTo(REEL_W*2+GAP*1.5, baseH+6);
    slot.addChild(gloss);
  }
  layoutReels(); app.renderer.on('resize', layoutReels);

  // ---------------- Spin Control（穴なし・サイズ崩れなし） ----------------
  const randChoice=a=>a[(Math.random()*a.length)|0];
  function advance(dt){
    for(const r of reels){
      if(!r.spinning) continue;
      const n=r.c.children.length, colH=n*REEL_H, half=colH*.5;
      for(const sp of r.c.children){ sp.y+=r.vy*dt; if(sp.y>half) sp.y-=colH; }
    }
  }
  function nearestTop(rc){
    let best=null,dist=1e9,idx=0; rc.children.forEach((sp,i)=>{ const d=Math.abs(sp.y); if(d<dist){best=sp;dist=d;idx=i;} });
    return {spr:best, symIdx: idx % SYMBOLS.length};
  }
  async function stopReelTo(i,ch){
    const r=reels[i]; const targetIdx=SYMBOLS.findIndex(s=>s.ch===ch) >=0 ? SYMBOLS.findIndex(s=>s.ch===ch) : SYMBOLS.findIndex(s=>s.ch==='⭐');
    const easeOut=t=>1-Math.pow(1-t,2.2); const startVy=r.vy; const dur=700+i*130; const t0=performance.now();
    return new Promise(res=>{
      (function step(){
        const t=(performance.now()-t0)/dur;
        if(t>=1){
          r.vy=0; r.spinning=false;
          const {spr:top,symIdx:topIdx}=nearestTop(r.c);
          const diff=(targetIdx-topIdx+SYMBOLS.length)%SYMBOLS.length;
          const adjust=diff*REEL_H; r.c.children.forEach(s=>s.y-=adjust);
          const off=top.y-adjust; r.c.children.forEach(s=>{ s.y-=off; s.y=Math.round(s.y/REEL_H)*REEL_H; });
          bounce(i); return res();
        }
        r.vy = startVy * (1 - easeOut(t)) + 2.2;
        advance(1); requestAnimationFrame(step);
      })();
    });
  }
  async function spinReels(finals=null){
    pressButtons();
    for(let i=0;i<3;i++){ const r=reels[i]; r.spinning=true; r.vy=48+i*4; }
    const t0=performance.now(); while(performance.now()-t0<420){ advance(1); await new Promise(r=>requestAnimationFrame(r)); }
    const t1=performance.now(); while(performance.now()-t1<340+Math.random()*220){ advance(1); await new Promise(r=>requestAnimationFrame(r)); }
    const f = (finals && finals.length===3)? finals : [randChoice(SYMBOLS).ch, randChoice(SYMBOLS).ch, randChoice(SYMBOLS).ch];
    for(let i=0;i<3;i++) await stopReelTo(i,f[i]);
    return f;
  }
  function bounce(i){
    const r=reels[i].c; const D1=80,D2=100; const sy0=1,sy1=.92; const t0=performance.now();
    (function step(){ const t=performance.now()-t0; if(t>=D1+D2){ r.scale.y=1; return; }
      if(t<D1){ const p=t/D1; r.scale.y=sy0+(sy1-sy0)*p; } else { const p=(t-D1)/D2; r.scale.y=sy1+(sy0-sy1)*p; }
      requestAnimationFrame(step); })();
  }

  // ---------------- FX ----------------
  function sparkle(x,y,n=24,color=0x66ccff){ for(let i=0;i<n;i++){ const d=new PIXI.Graphics().beginFill(0xffffff).drawCircle(0,0,Math.random()*1.8+.7).endFill();
    const s=new PIXI.Sprite(app.renderer.generateTexture(d)); s.x=x; s.y=y; s.tint=color; s.alpha=.9; s.blendMode=PIXI.BLEND_MODES.ADD;
    s.vx=(Math.random()*2-1)*(3+Math.random()*3); s.vy=(Math.random()*2-1)*(3+Math.random()*3); s.vr=(Math.random()*2-1)*.12; s.life=36+(Math.random()*12|0); fxLayer.addChild(s); } }
  function coinRain(count=26){ const {width:W}=app.renderer; for(let i=0;i<count;i++){ setTimeout(()=>{ const t=new PIXI.Text('🪙',{fontSize:32}); t.x=Math.random()*W; t.y=-20; t.vy=2+Math.random()*2.5; t.vx=(Math.random()*2-1)*.6; t.alpha=.92; t.blendMode=PIXI.BLEND_MODES.SCREEN;
    t.update=()=>{ t.x+=t.vx; t.y+=t.vy; t.vy+=.04; if(t.y>app.renderer.height+40) t.destroy(); }; fxLayer.addChild(t); }, i*40); } }
  function flash(ms=260){ const r=new PIXI.Graphics().beginFill(0xffffff,.9).drawRect(0,0,app.renderer.width,app.renderer.height).endFill(); fxLayer.addChild(r); const t0=performance.now();
    (function step(){ const t=(performance.now()-t0)/ms; if(t>=1){ r.destroy(); return; } r.alpha=.9*(1-t); requestAnimationFrame(step); })(); }
  app.ticker.add(()=>{ for(const s of fxLayer.children){ if(s.life!==undefined){ s.x+=s.vx; s.y+=s.vy; s.rotation+=s.vr; s.alpha-=.02; s.life--; if(s.life<=0||s.alpha<=0) s.destroy(); } else if(s.update){ s.update(); } } });

  // ---------------- Combo & meters ----------------
  let jpValue=0; function addJP(delta){ jpValue=clamp(jpValue+delta/6000,0,1); }
  setInterval(()=>{ jpValue=clamp(jpValue-0.0025,0,1); }, 220);
  let lastHit=0, combo=1.0;
  function onCombo(extend=true){ const t=performance.now(),dt=(t-lastHit)/1000; lastHit=t; combo=(extend&&dt<2.5)? clamp(combo+.25,1,5):1; }

  // ---------------- Buttons / GOGO! lamp helpers ----------------
  function pressButtons(){
    btnL.classList.add('press'); setTimeout(()=>btnL.classList.remove('press'),160);
    setTimeout(()=>{ btnC.classList.add('press'); setTimeout(()=>btnC.classList.remove('press'),160); }, 100);
    setTimeout(()=>{ btnR.classList.add('press'); setTimeout(()=>btnR.classList.remove('press'),160); }, 200);
  }
  function setGogo(on){
    gogo.classList.toggle('on', !!on);
    cab.classList.toggle('flash', !!on);
    if(on){ setTimeout(()=>{ gogo.classList.remove('on'); cab.classList.remove('flash'); }, 2600); }
  }

  // ---------------- Leaderboard ----------------
  function renderLB(list){ lbEl.innerHTML=''; (list||[]).forEach((it,i)=>{ const row=document.createElement('div'); row.className='lb-row';
    row.innerHTML=`<div>${String(i+1).padStart(2,'0')}</div><div class="u">${escapeHTML(it.userId||'anon')}</div><div>${Number(it.score||0).toLocaleString()}</div>`; lbEl.appendChild(row); }); }
  const escapeHTML = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));

  // ---------------- Socket & Queue ----------------
  const socket = io('/overlay',{transports:['websocket'], timeout:8000, reconnection:true, reconnectionDelay:800, reconnectionDelayMax:4000});
  socket.on('connect', ()=>{ conn.textContent='connected'; conn.style.color='var(--good)'; });
  socket.on('disconnect', ()=>{ conn.textContent='disconnected'; conn.style.color='var(--hot)'; });
  socket.on('connect_error', ()=>{ conn.textContent='error'; conn.style.color='var(--hot)'; });

  const sleep=ms=>new Promise(r=>setTimeout(r,ms));
  const q=[]; let draining=false; let PACE_MS=180;
  function enqueue(kind,payload){ if(kind==='bonus'&&q.length>=1) q.splice(1,0,{kind,payload}); else q.push({kind,payload}); if(!draining) drain(); }
  async function drain(){ draining=true; while(q.length){ const job=q.shift(); if(job.kind==='event') await handleEvent(job.payload); else await handleBonus(job.payload); await sleep(PACE_MS); } draining=false; }

  // 進捗（サーバのLua原子化に同期）
  let THRESHOLD=10;
  socket.on('bonus:progress', p=>{
    THRESHOLD=Number(p?.threshold||10);
    const after=Number(p?.after||0), remain=Number(p?.remain||0);
    const done= remain===0 ? 0 : (THRESHOLD-remain);
    mBonus.textContent = `${done}/${THRESHOLD}`;
  });

  socket.on('config:update', cfg=>{
    if(typeof cfg?.paceMs==='number') PACE_MS=Math.max(80,Math.min(800,Math.floor(cfg.paceMs)));
  });

  socket.on('play:event', (payload)=>enqueue('event',payload));
  socket.on('play:bonus', (payload)=>enqueue('bonus',payload));
  socket.on('leaderboard:update', (top10)=>renderLB(top10||[]));
  socket.on('hello', p=>log(`hello: ${new Date(p.ts).toLocaleTimeString()}`));

  async function handleEvent(payload){
    try{
      if(payload && payload.spin){
        const { tier, symbols, multiplier, bonusGame, comboExtend } = payload.spin;
        onCombo(comboExtend!==false);
        addJP((payload.jpDelta||0)+(payload.score||0));
        await spinReels(Array.isArray(symbols)&&symbols.length===3? symbols : null);
        const cx=app.renderer.width/2, cy=app.renderer.height/2;
        sparkle(cx,cy-10, tier==='MEGA'?36: tier==='HIGH'?26:18, tier==='MEGA'?0xff4d67: tier==='HIGH'?0x00e5a8:0x7bb0ff);
        coinRain(tier==='MEGA'?56: tier==='HIGH'?32:22);
        if(tier==='MEGA'||bonusGame){ flash(320); setGogo(true); }
        log(`+${payload.score||0}  ${payload.userId||'anon'}  [${tier}] x${(multiplier||1).toFixed(2)}  jp:+${payload.jpDelta||0}`);
        // メーター表示更新
        mCount.textContent = fmt3(payload.score||0);
        mCredit.textContent = fmt3(Math.round(jpValue*999));
        return;
      }
      // 旧形式フォールバック
      const { userId, fallen=0, bonus=0, jpDelta=0, score=0 } = payload||{};
      onCombo(true); addJP((jpDelta||0)+(score||0));
      await spinReels(fallen>=3||bonus>0? ['7','7','7']: null);
      const r=app.renderer; sparkle(r.width/2,r.height/2-10,24,0x66ccff);
      coinRain(18+(bonus>0?12:0));
      if(fallen>=3||bonus>0){ flash(320); setGogo(true); }
      log(`+${score}  ${userId||'anon'}  (fallen:${fallen}, bonus:${bonus}, jp:+${jpDelta})`);
      mCount.textContent = fmt3(score||0); mCredit.textContent = fmt3(Math.round(jpValue*999));
    }catch(e){ console.error(e); }
  }

  async function handleBonus(p){
    try{
      flash(340); setGogo(true);
      await spinReels(['7','7','7']);
      const cx=app.renderer.width/2, cy=app.renderer.height/2;
      coinRain(120); sparkle(cx,cy-12,72,0xffe066);
      log(`🌟 GLOBAL BONUS +${p?.bonusScore||100} by ${p?.userId||'anon'}`);
      mCount.textContent=fmt3(p?.bonusScore||100);
      mCredit.textContent=fmt3(Math.round(jpValue*999));
      // 表示上は 0/start に戻す（progress イベントでも更新される）
      mBonus.textContent=`0/${THRESHOLD}`;
    }catch(e){ console.error(e); }
  }

  // 初期データ
  fetch('/overlay/state').then(r=>r.json()).then(d=>renderLB(d.top10||[])).catch(()=>{});
  fetch('/bonus/state').then(r=>r.json()).then(b=>{
    THRESHOLD=Number(b?.threshold||10); const remain=Number(b?.remain||0); const done= remain===0?0:(THRESHOLD-remain);
    mBonus.textContent=`${done}/${THRESHOLD}`;
  }).catch(()=>{});
  </script>
</body>
</html>
